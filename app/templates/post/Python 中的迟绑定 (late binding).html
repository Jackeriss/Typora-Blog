{% extends "../base.html" %}{% block description %}Python 中的迟绑定 (late binding){% end %}{% block title %}Python 中的迟绑定 (late binding){% end %}{% block section %}<div class="postBlock"><body class="typora-export">
<div class="is-mac" id="write"><h2><a class="md-header-anchor " name="header-n0"></a>Python 中的迟绑定 (late binding)</h2><div class="time">                                               <input type="hidden" value="{{                                                timestamp }}"/></div><p></p><div class="a"><blockquote><p>Python 只有在需要时才去寻找变量的值</p></blockquote><p>定义一个函数：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">example</span>(<span class="cm-variable">x</span>):</span></pre></div><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">return</span> <span class="cm-variable">x</span> <span class="cm-operator">*</span> <span class="cm-variable">var</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p>变量 var 尚不存在，然而 python 并不会在执行 def 语句的时候报错。在这个阶段 python 并不会去寻找变量 var 的值。</p></div><p>当调用这个函数时：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">example</span>(<span class="cm-number">6</span>)</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">NameError</span>: <span class="cm-keyword">global</span> <span class="cm-variable">name</span> <span class="cm-string">'var'</span> <span class="cm-keyword">is</span> <span class="cm-keyword">not</span> <span class="cm-variable">defined</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 44px;"></div></div></div></pre><p>现在报错了，所以 python 只有在你调用 example 函数时才会寻找 var 变量。</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">var</span> = <span class="cm-number">10</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">example</span>(<span class="cm-number">6</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">60</span><span class="cm-comment"># var is referring to 10</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">var</span> = <span class="cm-number">20</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">example</span>(<span class="cm-number">6</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">120</span><span class="cm-comment"># var is referring to 20</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p>现在我们来判断一下这两段代码的执行结果：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">foo</span>(<span class="cm-variable">y</span>):</span></pre></div><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">return</span> <span class="cm-keyword">lambda</span> <span class="cm-variable">y</span> : <span class="cm-variable">y</span> <span class="cm-operator">*</span> <span class="cm-number">2</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">print</span>(<span class="cm-variable">foo</span>(<span class="cm-number">4</span>)(<span class="cm-number">1</span>))</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">bar</span>(<span class="cm-variable">y</span>):</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">return</span> <span class="cm-keyword">lambda</span> <span class="cm-variable">x</span> : <span class="cm-variable">y</span> <span class="cm-operator">*</span> <span class="cm-number">2</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">print</span>(<span class="cm-variable">bar</span>(<span class="cm-number">4</span>)(<span class="cm-number">1</span>))</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 154px;"></div></div></div></pre><p>第一段代码结果为 2，因为在 lambda 函数被调用时 y 的值为 1。
第二段代码结果为 8，因为在 lambda 函数被调用时 y 的值为 4。</p><p>下面这段代码被视为 Python 程序员常犯的错误：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">create_multipliers</span>():</span></pre></div><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">return</span> [<span class="cm-keyword">lambda</span> <span class="cm-variable">x</span> : <span class="cm-variable">i</span> <span class="cm-operator">*</span> <span class="cm-variable">x</span> <span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-builtin">range</span>(<span class="cm-number">5</span>)]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">multiplier</span> <span class="cm-keyword">in</span> <span class="cm-variable">create_multipliers</span>():</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">print</span> <span class="cm-variable">multiplier</span>(<span class="cm-number">2</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p>预期的结果：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">0</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">2</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">4</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">6</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">8</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><p>实际执行结果却是：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">8</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">8</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">8</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">8</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-number">8</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 110px;"></div></div></div></pre><p>在了解了 python 迟绑定的特性之后可以判断是因为在 lambda 函数实际执行的时候循环早已结束，而此时的 i 等于 4。</p><p>如果想达到预期的效果可以这样写：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">create_multipliers</span>():</span></pre></div><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">return</span> [<span class="cm-keyword">lambda</span> <span class="cm-variable">x</span>, <span class="cm-variable">i</span> = <span class="cm-variable">i</span> : <span class="cm-variable">i</span> <span class="cm-operator">*</span> <span class="cm-variable">x</span> <span class="cm-keyword">for</span> <span class="cm-variable">i</span> <span class="cm-keyword">in</span> <span class="cm-builtin">range</span>(<span class="cm-number">5</span>)]</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">for</span> <span class="cm-variable">multiplier</span> <span class="cm-keyword">in</span> <span class="cm-variable">create_multipliers</span>():</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">print</span> <span class="cm-variable">multiplier</span>(<span class="cm-number">2</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 88px;"></div></div></div></pre><p>这样，lambda 函数中的 i 就在每次循环中被赋值了。</p></div>
</body><div id="gitalk-container"></div></div>{% end %}