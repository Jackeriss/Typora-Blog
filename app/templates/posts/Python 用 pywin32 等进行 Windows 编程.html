{% extends "../base.html" %}{% block description %}Python 用 pywin32 等进行 Windows 编程{% end %}{% block title %}Python 用 pywin32 等进行 Windows 编程{% end %}{% block section %}<div class="postBlock"><body class="typora-export">
<div class="is-mac" id="write"><h2><a class="md-header-anchor " name="header-c5"></a>Python 用 pywin32 等进行 Windows 编程</h2><div class="time">                                               <input type="hidden" value="{{                                                timestamp }}"/></div><p>最近，我在 Windows 上做了不少小玩意儿，用到了很多 Windows 编程相关的模块。其中用到最多的当属 pywin32 这个模块，它为 Python 的 Windows 编程提供了极大的便利，今天就为大家介绍一些 Python 进行Windows 编程时常见功能的实现。</p><h4><a class="md-header-anchor " name="header-c11"></a>模拟按键</h4><p>以下代码模拟了粘贴的快捷键<code>ctrl + v</code>：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -*- coding: utf-8 -*-</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">win32api</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">win32con</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">win32api</span>.<span class="cm-property">keybd_event</span>(<span class="cm-number">17</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 按下 ctrl 键，其键位码是 17</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">win32api</span>.<span class="cm-property">keybd_event</span>(<span class="cm-number">86</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 按下 v 键，其键位码是 86</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">win32api</span>.<span class="cm-property">keybd_event</span>(<span class="cm-number">86</span>, <span class="cm-number">0</span>, <span class="cm-variable">win32con</span>.<span class="cm-property">KEYEVENTF_KEYUP</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 释放按键</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">win32api</span>.<span class="cm-property">keybd_event</span>(<span class="cm-number">17</span>, <span class="cm-number">0</span>, <span class="cm-variable">win32con</span>.<span class="cm-property">KEYEVENTF_KEYUP</span>, <span class="cm-number">0</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p>字母和数字按键的键位码与其 ASCII 码相同，用 Python 的 ord 函数可以快速得到。其他特殊按键的键位码请自行搜索<code>键位码表</code></p><h4><a class="md-header-anchor " name="header-c17"></a>事件监听</h4><p>使用 pyHook 模块进行按键监听：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -*- coding: cp936 -*-</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pythoncom</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pyHook</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 监听鼠标事件      </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">onMouseEvent</span>(<span class="cm-variable">event</span>):</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">print</span> <span class="cm-string">"mouse down"</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">return</span> <span class="cm-builtin">True</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 监听键盘事件 </span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">onKeyboardEvent</span>(<span class="cm-variable">event</span>):</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">print</span> <span class="cm-builtin">chr</span>(<span class="cm-variable">event</span>.<span class="cm-property">Ascii</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">return</span> <span class="cm-builtin">True</span></span></pre><pre class=""><span style="padding-right: 0.1px;">  </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">__name__</span> == <span class="cm-string">"__main__"</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">hm</span> = <span class="cm-variable">pyHook</span>.<span class="cm-property">HookManager</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-comment"># 监控鼠标</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">hm</span>.<span class="cm-property">SubscribeMouseLeftDown</span>(<span class="cm-variable">onMouseEvent</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">hm</span>.<span class="cm-property">HookMouse</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-comment"># 监控键盘</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">hm</span>.<span class="cm-property">KeyDown</span> = <span class="cm-variable">onKeyboardEvent</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">hm</span>.<span class="cm-property">HookKeyboard</span>() </span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-comment"># 循环获取消息</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">pythoncom</span>.<span class="cm-property">PumpMessages</span>() </span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 528px;"></div></div></div></pre><p></p><h4><a class="md-header-anchor " name="header-c23"></a>模拟鼠标</h4><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -*- coding: utf-8 -*-</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">win32api</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">win32con</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">ctypes</span> <span class="cm-keyword">import</span> <span class="cm-operator">*</span> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">windll</span>.<span class="cm-property">user32</span>.<span class="cm-property">SetCursorPos</span>(<span class="cm-number">100</span>, <span class="cm-number">100</span>) <span class="cm-comment"># 设置鼠标位置</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">win32api</span>.<span class="cm-property">mouse_event</span>(<span class="cm-variable">win32con</span>.<span class="cm-property">MOUSEEVENTF_LEFTDOWN</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 按下鼠标左键</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">win32api</span>.<span class="cm-property">mouse_event</span>(<span class="cm-variable">win32con</span>.<span class="cm-property">MOUSEEVENTF_LEFTUP</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 释放鼠标左键</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 220px;"></div></div></div></pre><h4><a class="md-header-anchor " name="header-c25"></a>使用剪切板</h4><p>主要利用了 pywin32 中的 win32clipboard 模块。</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -*- coding: utf-8 -*-</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">sys</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">win32clipboard</span> <span class="cm-keyword">as</span> <span class="cm-variable">w</span> </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">win32con</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">win32api</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 读取剪切板</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">getText</span>():</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">w</span>.<span class="cm-property">OpenClipboard</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">data</span> = <span class="cm-variable">w</span>.<span class="cm-property">GetClipboardData</span>(<span class="cm-variable">win32con</span>.<span class="cm-property">CF_TEXT</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">w</span>.<span class="cm-property">CloseClipboard</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">return</span> <span class="cm-variable">data</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 写入剪切板</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">setText</span>(<span class="cm-variable">aString</span>):</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">w</span>.<span class="cm-property">OpenClipboard</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">w</span>.<span class="cm-property">EmptyClipboard</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">w</span>.<span class="cm-property">SetClipboardData</span>(<span class="cm-variable">win32con</span>.<span class="cm-property">CF_TEXT</span>, <span class="cm-variable">aString</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">w</span>.<span class="cm-property">CloseClipboard</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">    </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">__name__</span>==<span class="cm-string">'__main__'</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">a</span> = <span class="cm-string">"你好"</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">setText</span>(<span class="cm-variable">a</span>) <span class="cm-comment"># 将“你好”写入剪切板</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-comment"># 自动粘贴剪切板中的内容</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">win32api</span>.<span class="cm-property">keybd_event</span>(<span class="cm-number">17</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 模拟按下 ctrl 键</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">win32api</span>.<span class="cm-property">keybd_event</span>(<span class="cm-number">86</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 模拟按下 v 键</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">win32api</span>.<span class="cm-property">keybd_event</span>(<span class="cm-number">86</span>, <span class="cm-number">0</span>, <span class="cm-variable">win32con</span>.<span class="cm-property">KEYEVENTF_KEYUP</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 释放 ctrl 键</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">win32api</span>.<span class="cm-property">keybd_event</span>(<span class="cm-number">17</span>, <span class="cm-number">0</span>, <span class="cm-variable">win32con</span>.<span class="cm-property">KEYEVENTF_KEYUP</span>, <span class="cm-number">0</span>) <span class="cm-comment"># 释放 v 键</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 682px;"></div></div></div></pre><h4><a class="md-header-anchor " name="header-c29"></a>获取特殊文件夹路径</h4><p>有时候你想给你的程序添加桌面快捷方式，但却连桌面的准确路径都不知道，还好微软给出了获取一些特殊文件夹路径的方法，在 Python 使用 win32com 模块即可实现。</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -*- coding: cp936 -*-</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">win32com</span>.<span class="cm-property">shell</span> <span class="cm-keyword">import</span> <span class="cm-variable">shell</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">win32com</span>.<span class="cm-property">shell</span> <span class="cm-keyword">import</span> <span class="cm-variable">shellcon</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 获取"启动"文件夹路径，关键是最后的参数 CSIDL_STARTUP，这些参数可以在微软的官方文档中找到</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">startup_path</span> = <span class="cm-variable">shell</span>.<span class="cm-property">SHGetPathFromIDList</span>(<span class="cm-variable">shell</span>.<span class="cm-property">SHGetSpecialFolderLocation</span>(<span class="cm-number">0</span>, <span class="cm-variable">shellcon</span>.<span class="cm-property">CSIDL_STARTUP</span>)) </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># 获取"桌面"文件夹路径，将最后的参数换成 CSIDL_DESKTOP 即可</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-variable">desktop_path</span> = <span class="cm-variable">shell</span>.<span class="cm-property">SHGetPathFromIDList</span>(<span class="cm-variable">shell</span>.<span class="cm-property">SHGetSpecialFolderLocation</span>(<span class="cm-number">0</span>, <span class="cm-variable">shellcon</span>.<span class="cm-property">CSIDL_DESKTOP</span>))</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">__name__</span> == <span class="cm-string">"__main__"</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">print</span> <span class="cm-variable">startup_path</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">print</span> <span class="cm-variable">desktop_path</span></span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 374px;"></div></div></div></pre><p>CSIDL 参数与各文件夹的对应表，详见微软官方文档：<a href="http://msdn.microsoft.com/en-us/library/bb762494(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/bb762494(v=vs.85).aspx</a></p><h4><a class="md-header-anchor " name="header-c35"></a>创建快捷方式</h4><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -*- coding: cp936 -*- </span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">os</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">pythoncom</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">win32com</span>.<span class="cm-property">shell</span> <span class="cm-keyword">import</span> <span class="cm-variable">shell</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">win32com</span>.<span class="cm-property">shell</span> <span class="cm-keyword">import</span> <span class="cm-variable">shellcon</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">set_shortcut</span>(<span class="cm-variable">filename</span>,<span class="cm-variable">lnkname</span>,<span class="cm-variable">iconname</span>): <span class="cm-comment"># 如无需特别设置图标，则可去掉iconname参数</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">shortcut</span> = <span class="cm-variable">pythoncom</span>.<span class="cm-property">CoCreateInstance</span>(<span class="cm-variable">shell</span>.<span class="cm-property">CLSID_ShellLink</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">                                          <span class="cm-builtin">None</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-tab">    </span>  <span class="cm-variable">pythoncom</span>.<span class="cm-property">CLSCTX_INPROC_SERVER</span>,</span></pre><pre class=""><span style="padding-right: 0.1px;">                                          <span class="cm-variable">shell</span>.<span class="cm-property">IID_IShellLink</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">shortcut</span>.<span class="cm-property">SetPath</span>(<span class="cm-variable">filename</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">shortcut</span>.<span class="cm-property">SetWorkingDirectory</span>(<span class="cm-variable">filename</span>.<span class="cm-property">strip</span>(<span class="cm-string">"\\"</span><span class="cm-operator">+</span><span class="cm-variable">filename</span>.<span class="cm-property">split</span>(<span class="cm-string">"\\"</span>)[<span class="cm-operator">-</span><span class="cm-number">1</span>])) <span class="cm-comment"># 设置快捷方式的起始位置（即文件所在的目录）  </span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">shortcut</span>.<span class="cm-property">SetIconLocation</span>(<span class="cm-variable">iconname</span>,<span class="cm-number">0</span>) <span class="cm-comment"># 可有可无，没有就默认使用文件本身的图标  </span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">if</span> <span class="cm-variable">os</span>.<span class="cm-property">path</span>.<span class="cm-property">splitext</span>(<span class="cm-variable">lnkname</span>)[<span class="cm-operator">-</span><span class="cm-number">1</span>] <span class="cm-operator">!</span>= <span class="cm-string">'.lnk'</span>:  </span></pre><pre class=""><span style="padding-right: 0.1px;">        <span class="cm-variable">lnkname</span> += <span class="cm-string">".lnk"</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">shortcut</span>.<span class="cm-property">QueryInterface</span>(<span class="cm-variable">pythoncom</span>.<span class="cm-property">IID_IPersistFile</span>).<span class="cm-property">Save</span>(<span class="cm-variable">lnkname</span>, <span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">      </span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">__name__</span> == <span class="cm-string">"__main__"</span>:  </span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-comment"># 获取"启动"文件夹路径，关键是最后的参数CSIDL_STARTUP，这些参数可以在微软的官方API中找到  </span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">startup_path</span> = <span class="cm-variable">shell</span>.<span class="cm-property">SHGetPathFromIDList</span>(<span class="cm-variable">shell</span>.<span class="cm-property">SHGetSpecialFolderLocation</span>(<span class="cm-number">0</span>, <span class="cm-variable">shellcon</span>.<span class="cm-property">CSIDL_STARTUP</span>))  </span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-comment"># 获取"桌面"文件夹路径，将最后的参数换成CSIDL_DESKTOP即可  </span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">desktop_path</span> = <span class="cm-variable">shell</span>.<span class="cm-property">SHGetPathFromIDList</span>(<span class="cm-variable">shell</span>.<span class="cm-property">SHGetSpecialFolderLocation</span>(<span class="cm-number">0</span>, <span class="cm-variable">shellcon</span>.<span class="cm-property">CSIDL_DESKTOP</span>))  </span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">file_name</span> = <span class="cm-string">""</span> <span class="cm-comment"># 要创建快捷方式的文件的完整路径</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">icon_name</span> = <span class="cm-string">""</span> <span class="cm-comment"># 图标文件的完整路径(非必须)</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">lnk_name1</span> = <span class="cm-variable">startup_path</span><span class="cm-operator">+</span><span class="cm-string">"\我的桌面快捷方式.lnk"</span> <span class="cm-comment"># 将要在此路径创建快捷方式</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">lnk_name2</span> = <span class="cm-variable">startup_path</span><span class="cm-operator">+</span><span class="cm-string">"\我的启动组快捷方式.lnk"</span></span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">set_shortcut</span>(<span class="cm-variable">file_name</span>, <span class="cm-variable">lnk_name1</span>, <span class="cm-variable">icon_name</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-variable">set_shortcut</span>(<span class="cm-variable">file_name</span>, <span class="cm-variable">lnk_name2</span>, <span class="cm-variable">icon_name</span>)</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 924px;"></div></div></div></pre><h4><a class="md-header-anchor " name="header-c37"></a>限制只能同时运行一个程序的实例</h4><p>首先写一个 singleinstance 模块，内容如下：</p><pre class="md-fences md-end-block" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap " lang="python"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -*- coding: utf-8 -*-</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">win32event</span> <span class="cm-keyword">import</span> <span class="cm-variable">CreateMutex</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">win32api</span> <span class="cm-keyword">import</span> <span class="cm-variable">CloseHandle</span>, <span class="cm-variable">GetLastError</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">winerror</span> <span class="cm-keyword">import</span> <span class="cm-variable">ERROR_ALREADY_EXISTS</span></span></pre><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre></div><div class="" style="position: relative;"><pre><span style="padding-right: 0.1px;"><span class="cm-keyword">class</span> <span class="cm-def">singleinstance</span>:</span></pre></div><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">def</span> <span class="cm-def">__init__</span>(<span class="cm-variable-2">self</span>):</span></pre><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;">        <span class="cm-variable-2">self</span>.<span class="cm-property">mutexname</span> = <span class="cm-string">"testmutex_{D0E858DF-985E-4907-B7FB-8D732C3FC3B9}"</span> <span class="cm-comment"># 独一无二的名称(不同的程序请用不同的 mutexname)</span></span></pre></div><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;">        <span class="cm-variable-2">self</span>.<span class="cm-property">mutex</span> = <span class="cm-variable">CreateMutex</span>(<span class="cm-builtin">None</span>, <span class="cm-builtin">False</span>, <span class="cm-variable-2">self</span>.<span class="cm-property">mutexname</span>)</span></pre></div><pre><span style="padding-right: 0.1px;">        <span class="cm-variable-2">self</span>.<span class="cm-property">lasterror</span> = <span class="cm-variable">GetLastError</span>()</span></pre><pre class=""><span style="padding-right: 0.1px;">    </span></pre><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">def</span> <span class="cm-def">aleradyrunning</span>(<span class="cm-variable-2">self</span>):</span></pre></div><pre class=""><span style="padding-right: 0.1px;">        <span class="cm-keyword">return</span> (<span class="cm-variable-2">self</span>.<span class="cm-property">lasterror</span> == <span class="cm-variable">ERROR_ALREADY_EXISTS</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;">        </span></pre><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;">    <span class="cm-keyword">def</span> <span class="cm-def">__del__</span>(<span class="cm-variable-2">self</span>):</span></pre></div><pre class=""><span style="padding-right: 0.1px;">        <span class="cm-keyword">if</span> <span class="cm-variable-2">self</span>.<span class="cm-property">mutex</span>:</span></pre><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;">            <span class="cm-variable">CloseHandle</span>(<span class="cm-variable-2">self</span>.<span class="cm-property">mutex</span>)</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 396px;"></div></div></div></pre><p>使用示例：</p><pre class="md-fences md-end-block md-focus" lang="python"> <div class="CodeMirror cm-s-inner CodeMirror-wrap CodeMirror-focused"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 220px; left: 230px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;"><span class="cm-comment"># -*- coding: utf-8 -*-</span></span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">import</span> <span class="cm-variable">time</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">from</span> <span class="cm-variable">singleinstance</span> <span class="cm-keyword">import</span> <span class="cm-variable">singleinstance</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">def</span> <span class="cm-def">main</span>():</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">while</span> <span class="cm-number">1</span>:</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-keyword">print</span> <span class="cm-string">"1"</span></span></pre><pre class=""><span style="padding-right: 0.1px;">        <span class="cm-variable">time</span>.<span class="cm-property">sleep</span>(<span class="cm-number">5</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span>​</span></span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-keyword">if</span> <span class="cm-variable">__name__</span> == <span class="cm-string">'__main__'</span>:</span></pre><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-variable">myapp</span> = <span class="cm-variable">singleinstance</span>()</span></pre></div><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">if</span> <span class="cm-variable">myapp</span>.<span class="cm-property">aleradyrunning</span>():</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span><span class="cm-variable">sys</span>.<span class="cm-property">exit</span>(<span class="cm-number">0</span>)</span></pre><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-keyword">else</span>:</span></pre><div class="" style="position: relative;"><pre class=""><span style="padding-right: 0.1px;"><span class="cm-tab">    </span><span class="cm-tab">    </span> <span class="cm-variable">main</span>()</span></pre></div></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 330px;"></div></div></div></pre><p>掌握了上面的各种方法，用它们来做什么就看你的想象力了，我做过炉石传说抱歉脚本、自动选课脚本、 QQ 消息轰炸机以及一个键盘记录木马。。。开个安卓模拟器来抢红包也是个不错的主意。</p></div>
</body><div id="comments"></div><script type="text/javascript">const gitment = new Gitment({id: "Python 用 pywin32 等进行 Windows 编程",owner: "Jackeriss",repo: "comments_of_www.jackeriss.com",oauth: {  client_id: "748b4dac7ace16b6d7cb",  client_secret: "c5db352dad6f88b898840d628e44cfb5b4eaf4c0",},});gitment.render("comments")</script>{% end %}