{% extends "../base.html" %}{% block description %}使用 nginx-proxy 部署 web 应用{% end %}{% block title %}使用 nginx-proxy 部署 web 应用{% end %}{% block section %}<div class="postBlock"><body class="typora-export">
<div class="is-mac" id="write"><h2><a class="md-header-anchor " name="header-c5"></a>使用 nginx-proxy 部署 web 应用</h2><div class="time">                                               <input type="hidden" value="{{                                                timestamp }}"/></div><p>如何在一台 Web 服务器上部署多个 Web 应用且让他们使用不同的域名呢？常见的做法是用 Nginx 做反向代理。但如果 Web 应用是采用 Docker 部署的呢？如何方便的配置 nginx 的反向代理成了一个令人头疼的问题。nginx-proxy 就是为了解决这个问题而生的。它结合了 nginx 和 docker-gen，在主机上的容器启动和停止时 docker-gen 会生成 nginx 反向代理配置并且重新加载 nginx。</p><p>推荐使用 Daocloud 作为 Docker 应用的部署和管理平台，以下教程皆在此平台进行。</p><p>我们首先部署一个 nginx-proxy 到我们的服务器，Daocloud 上有一个和 Docker Hub 同步的 nginx-proxy 镜像，直接部署这个镜像就行了。其 YAML 如下：</p><pre class="md-fences md-end-block" lang="yaml"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><div style="width: 50px; height: 50px; overflow-x: scroll;"></div></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">nginx-proxy:</span></pre></div><pre class=""><span style="padding-right: 0.1px;">  image: daocloud.io/daocloud/nginx-proxy:latest</span></pre><pre class=""><span style="padding-right: 0.1px;">  container_name: nginx-proxy</span></pre><pre class=""><span style="padding-right: 0.1px;">  ports:</span></pre><pre class=""><span style="padding-right: 0.1px;">  - 80:80</span></pre><pre class=""><span style="padding-right: 0.1px;">  - 443:443</span></pre><pre class=""><span style="padding-right: 0.1px;">  volumes:</span></pre><pre class=""><span style="padding-right: 0.1px;">  - /var/run/docker.sock:/tmp/docker.sock:ro</span></pre><pre class=""><span style="padding-right: 0.1px;">  - /etc/nginx/certs:/etc/nginx/certs:ro</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><p>其中<code>/var/run/docker.sock:/tmp/docker.sock:ro</code>是必须的，而<code>/etc/nginx/certs:/etc/nginx/certs:ro</code>则只有开启 HTTPS 的网站才需要，且 SSL 密钥在服务器上的存储位置可以自定义，我这里选择了和容器内部相同的路径。</p><p>假如我们要部署 A、B 两个 Web 应用，A 应用使用<code>www.a.com</code>来访问，B 应用使用<code>www.b.com</code>来访问。那么 A、B 的 YAML 应分别设置如下：</p><pre class="md-fences md-end-block" lang="yaml"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">A:</span></pre></div><pre class=""><span style="padding-right: 0.1px;">  image: daocloud.io/jackeriss/a:latest</span></pre><pre class=""><span style="padding-right: 0.1px;">  container_name: a</span></pre><pre class=""><span style="padding-right: 0.1px;">  privileged: false</span></pre><pre class=""><span style="padding-right: 0.1px;">  restart: always</span></pre><pre class=""><span style="padding-right: 0.1px;">  ports:</span></pre><pre class=""><span style="padding-right: 0.1px;">  - '8080'</span></pre><pre class=""><span style="padding-right: 0.1px;">  environment:</span></pre><pre class=""><span style="padding-right: 0.1px;">  - VIRTUAL_HOST=www.a.com</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><pre class="md-fences md-end-block" lang="yaml"> <div class="CodeMirror cm-s-inner CodeMirror-wrap"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 0px; left: 4px;"></div><div class="CodeMirror-hscrollbar" style="left: 0px; min-height: 18px;"><div style="height: 100%; min-height: 1px; width: 0px;"></div></div><div class="CodeMirror-vscrollbar" style="min-width: 18px;"><div style="min-width: 1px; height: 0px;"></div></div><div class="CodeMirror-scrollbar-filler"></div><div class="CodeMirror-gutter-filler"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; min-height: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines"><div style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" style=""><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><pre class=""><span style="padding-right: 0.1px;">B:</span></pre></div><pre class=""><span style="padding-right: 0.1px;">  image: daocloud.io/jackeriss/b:latest</span></pre><pre class=""><span style="padding-right: 0.1px;">  container_name: b</span></pre><pre class=""><span style="padding-right: 0.1px;">  privileged: false</span></pre><pre class=""><span style="padding-right: 0.1px;">  restart: always</span></pre><pre class=""><span style="padding-right: 0.1px;">  ports:</span></pre><pre class=""><span style="padding-right: 0.1px;">  - '8081'</span></pre><pre class=""><span style="padding-right: 0.1px;">  environment:</span></pre><pre class=""><span style="padding-right: 0.1px;">  - VIRTUAL_HOST=www.b.com</span></pre></div></div></div></div></div><div style="position: absolute; height: 30px; width: 1px; top: 0px;"></div><div class="CodeMirror-gutters" style="display: none; height: 198px;"></div></div></div></pre><h4><a class="md-header-anchor " name="header-c22"></a>SSL 支持</h4><p>刚才说了如果想让网站支持 HTTPS 协议要额外添加一个 volume： <code>/etc/nginx/certs:/etc/nginx/certs:ro</code>。这个路径就是 SSL 密钥文件在服务器上的存储位置。以 A 应用为例，其 crt 文件应命名为<code>www.a.com.crt</code>，而 key 文件应命名为<code>www.a.com.key</code>，B 应用同理，都放在这个路径下。注意：不能对这两个文件的内容有任何的修改，包括标识开头和结束的<code>-----BEGIN CERTIFICATE-----</code>等，否则 nginx-proxy 会无法正常运行。</p><h4><a class="md-header-anchor " name="header-c25"></a>DNS 解析</h4><p>当然，A、B 两个应用的域名<code>a.com</code> 和 <code>b.com</code>的<code>www</code>主记录都应指向部署这两个应用的主机的外部 IP。解析生效后等待一段时间再访问这两个网址看看是否部署成功。</p><p>nginx-proxy 的使用方法就简单的给大家介绍到这里，更多高级用法，如自定义 nginx 配置文件等请参考官方的 README：<a href="https://github.com/jwilder/nginx-proxy" target="_blank">https://github.com/jwilder/nginx-proxy</a></p></div>
</body>{% end %}